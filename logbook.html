<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMC PKU Logbook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Load Supabase library FIRST -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Initialize Supabase client immediately and expose to window -->
    <script>
        // Konfigurasi Supabase
        const SUPABASE_URL = 'https://voqvauapafsdcmuswsnq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZ' +
            'SIsInJlZiI6InZvcXZhdWFwYWZzZGNtdXN3c25xIiwicm9sZSI6ImFub24iLCJpYXQiOjE' +
            '3NjYxNDMxNTYsImV4cCI6MjA4MTcxOTE1Nn0.IJG7ofqfc4Qy44KlbTDGzo4OoQwO0xTXU' +
            'wKPt04kRnI';

        // Create and expose supabaseClient to window scope IMMEDIATELY
        // This ensures logic.js logout function can access it
        if (typeof window.supabase !== 'undefined') {
            const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            window.supabaseClient = supabaseClient;
            console.log('Supabase client initialized and exposed to window (logbook)');
        } else {
            console.error('Supabase library not loaded!');
        }
    </script>
    
    <!-- Load logic.js AFTER Supabase client is initialized -->
    <script src="assets/logic.js"></script>
    <style>
       .hidden { display: none; }
        .form-check-input { cursor: pointer; border: 1px solid #0d6efd; }
        
        /* Sidebar Styles */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            min-width: 250px;
            max-width: 250px;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            transition: left 0.3s ease, transform 0.3s ease;
            min-height: 100vh;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
            transform: translateX(0);
        }
        
        #sidebar.active {
            left: -250px !important;
            transform: translateX(-250px) !important;
        }
        
        #sidebar .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
        }
        
        #sidebar ul.components {
            padding: 20px 0;
        }
        
        #sidebar ul li {
            padding: 10px;
            font-size: 1.1em;
            display: block;
        }
        
        #sidebar ul li a {
            padding: 10px 15px;
            font-size: 1em;
            display: block;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-radius: 5px;
        }
        
        #sidebar ul li a:hover,
        #sidebar ul li a.active {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }
        
        #sidebar ul li a i {
            margin-right: 10px;
        }
        
        #content {
            margin-left: 250px;
            width: calc(100% - 250px);
            padding: 20px;
            min-height: 100vh;
            transition: margin-left 0.3s ease, width 0.3s ease;
        }
        
        #sidebar.active ~ #content {
            margin-left: 0 !important;
            width: 100% !important;
        }
        
        .wrapper {
            width: 100%;
            position: relative;
        }
        
        #sidebarCollapse {
            background: #1e3c72;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #sidebarCollapse:hover {
            background: #2a5298;
        }
        
        /* CSS KHUSUS CETAK */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                display: block !important;
            }
            .page-break { page-break-after: always; }
            .no-print { display: none !important; }
            #sidebar { display: none !important; }
            #sidebarCollapse { display: none !important; }
        }

        .card-header { font-weight: bold; background-color: #f8f9fa; }
        .table-striped > tbody > tr:nth-of-type(odd) { --bs-table-accent-bg: rgba(0, 0, 0, 0.02); }
        .img-preview { max-width: 60px; height: auto; border-radius: 5px; border: 1px solid #ddd; margin: 2px; }
    </style>
</head>
<body class="bg-light">

<div class="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3><i class="bi bi-building-gear"></i> AMC</h3>
            <p class="mb-0">Sultan Syarif Kasim II</p>
        </div>

        <ul class="list-unstyled components">
             <li>
                <a href="dashboard.html">
                    <i class="bi bi-house"></i> Dashboard
                </a>
            </li>
            <li>
                <a href="checklist.html">
                    <i class="bi bi-card-checklist"></i> Checklist
                </a>
            </li>
            <li>
                <a href="#" onclick="showHome(); setActiveMenu(this); return false;" class="active">
                    <i class="bi bi-journal-check"></i> Logbook
                </a>
            </li>
            <li>
                <a href="admintim.html">
                    <i class="bi bi-display"></i> Admin TIM
                </a>
            </li>
             <li>
                <a href="#" onclick="logout(); return false;">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </li>
        </ul>

        <div class="px-3 mt-auto pb-3">
            <small class="text-white-50">Apron Movement Control PKU</small>
        </div>
    </nav>

    <!-- Page Content -->
    <div id="content">
        <button type="button" id="sidebarCollapse" class="btn mb-3" onclick="toggleSidebar()">
            <i class="bi bi-list"></i> Toggle Menu
        </button>

            <div id="homePage">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <h3 class="mb-0 text-primary"><i class="bi bi-journal-check"></i> Daily Logbook</h3>
                    <button class="btn btn-primary shadow-sm" onclick="showForm()"><i class="bi bi-plus-lg"></i> Tambah Log</button>
                </div>
            </div>
                <div class="card shadow-sm border-0 mb-4 no-print">
                    <div class="card-body row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="small fw-bold">Dari Tanggal</label>
                            <input type="date" id="filterFrom" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">Sampai Tanggal</label>
                            <input type="date" id="filterTo" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-dark w-100" onclick="fetchForPrint()"><i class="bi bi-printer"></i> Cetak Rekap</button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th class="ps-3">Waktu & Area</th>
                                    <th>Petugas</th>
                                    <th>Keterangan</th>
                                    <th>Foto</th>
                                    <th class="text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="logTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

    <div id="formPage" class="hidden">
        <div class="card shadow border-0 p-4">
            <div class="d-flex justify-content-between mb-4">
                <h4>Input Logbook Baru</h4>
                <button class="btn-close" onclick="showHome()"></button>
            </div>
            <form id="logForm" onsubmit="return handleSubmit(event)">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Tanggal & Jam</label>
                        <div class="input-group">
                            <input type="date" id="inDate" class="form-control" required>
                            <input type="time" id="inTime" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Area Pengecekan</label>
                        <select id="logArea" class="form-select" required>
                            <option value="">-- Pilih Area --</option>
                            <option value="Airside">Airside</option>
                            <option value="Apron">Apron</option>
                            <option value="Runway">Runway</option>
                            <option value="Taxiway">Taxiway</option>
                            <option value="Service Road">Service Road</option>
                            <option value="Access Road">Access Road</option>
                            <option value="Make up Area">Make Up Area</option>
                            <option value="Break Down Area">Break Down Area</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold">Nama Petugas</label>
                        <div id="staffList" class="mt-2"></div>
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="addStaffRow()">+ Tambah Petugas</button>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold">Keterangan</label>
                        <textarea id="inDesc" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold">Dokumentasi Foto</label>
                        <div id="photoList">
                            <input type="file" class="form-control mb-2 photo-input" accept="image/*" onchange="handleFile(this)">
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPhotoRow()">+ Tambah Foto</button>
                        <div id="previewBox" class="mt-2 d-flex flex-wrap"></div>
                    </div>
                </div>
                <hr class="my-4">
                <div class="text-end">
                    <button type="button" class="btn btn-secondary px-4" onclick="showHome()">Batal</button>
                    <button type="submit" id="btnSubmit" class="btn btn-success px-5">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>

    <div id="printArea"></div>
</div>

<script>
// ==========================================
// SIDEBAR TOGGLE - MUST BE FIRST!
// ==========================================
window.toggleSidebar = function() {
    console.log('toggleSidebar called');
    const sidebar = document.getElementById('sidebar');
    const content = document.getElementById('content');
    
    if (sidebar && content) {
        sidebar.classList.toggle('active');
        console.log('Sidebar toggled, active:', sidebar.classList.contains('active'));
    } else {
        console.error('Sidebar or content element not found!');
        console.log('Sidebar:', sidebar);
        console.log('Content:', content);
    }
};

// Use the globally initialized supabaseClient from window scope
const supabaseClient = window.supabaseClient;

function showHome() {
    var homePage = document.getElementById('homePage');
    var formPage = document.getElementById('formPage');
    homePage.classList.remove('hidden');
    formPage.classList.add('hidden');
    loadData();
}

function showForm() {
    var homePage = document.getElementById('homePage');
    var formPage = document.getElementById('formPage');
    homePage.classList.add('hidden');
    formPage.classList.remove('hidden');

    var now = new Date();
    document.getElementById('inDate').value = now.toISOString().split('T')[0];
    document.getElementById('inTime').value = now.toTimeString().slice(0, 5);
    document.getElementById('staffList').innerHTML = '';
}

function addStaffRow() {
    var staffList = document.getElementById('staffList');
    var select = document.createElement('select');
    select.className = 'form-select mb-2 staff-select';
    select.required = true;
    var options = '<option value="">-- Pilih Petugas --</option>';
    options += '<option value="Yeffi Suwono Putra">Yeffi S.Putra</option>';
    options += '<option value="Muhammad Abduh">Muhammad Abduh</option>';
    options += '<option value="Rangga Swardani Abadi">Rangga SWA</option>';
    options += '<option value="Herdin Jonathan Sibarani">Herdin Jo</option>';
    options += '<option value="Febri Antoni">Febri Antoni</option>';
    options += '<option value="Febriko Dwi Fatmi">Febriko DF</option>';
    options += '<option value="Andi Duriamin Siregar">Andi DS</option>';
    select.innerHTML = options;
    staffList.appendChild(select);
}

function addPhotoRow() {
    var input = document.createElement('input');
    input.type = 'file';
    input.className = 'form-control mb-2 photo-input';
    input.accept = 'image/*';
    input.onchange = function() { handleFile(this); };
    document.getElementById('photoList').appendChild(input);
}

function handleFile(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'img-preview';
            document.getElementById('previewBox').appendChild(img);
            input.dataset.blob = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function handleSubmit(e) {
    e.preventDefault();
    var btn = document.getElementById('btnSubmit');
    btn.disabled = true;
    btn.innerText = "Menyimpan...";

    var petugasArray = [];
    var staffSelects = document.querySelectorAll('#staffList .staff-select');
    for (var i = 0; i < staffSelects.length; i++) {
        if (staffSelects[i].value.trim() !== '') {
            petugasArray.push(staffSelects[i].value.trim());
        }
    }

    var photoInputs = document.querySelectorAll('.photo-input');
    var fotoArray = [];
    for (var j = 0; j < photoInputs.length; j++) {
        if (photoInputs[j].dataset.blob) {
            fotoArray.push(photoInputs[j].dataset.blob);
        }
    }

    var payload = {
        tanggal: document.getElementById('inDate').value,
        waktu: document.getElementById('inTime').value,
        area: document.getElementById('logArea').value,
        petugas: petugasArray,
        keterangan: document.getElementById('inDesc').value,
        foto: fotoArray
    };

    if (supabaseClient) {
        supabaseClient.from('logbook_daily').insert([payload]).then(function(response) {
            if (response.error) {
                alert("Error: " + response.error.message);
            } else {
                alert("Data Berhasil Disimpan!");
                document.getElementById('logForm').reset();
                document.getElementById('staffList').innerHTML = '';
                document.getElementById('previewBox').innerHTML = '';
                showHome();
            }
            btn.disabled = false;
            btn.innerText = "Simpan Data";
        });
    } else {
        alert("Supabase not initialized");
        btn.disabled = false;
        btn.innerText = "Simpan Data";
    }
    return false;
}

function loadData() {
    var tbody = document.getElementById('logTableBody');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Memuat data...</td></tr>';

    if (!supabaseClient) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-warning">Supabase not initialized</td></tr>';
        return;
    }

    supabaseClient.from('logbook_daily').select('*').order('tanggal', { ascending: false }).then(function(response) {
        if (response.error) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error memuat data</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        var data = response.data;
        for (var i = 0; i < data.length; i++) {
            var log = data[i];
            var row = document.createElement('tr');
            
            var petugasBadges = '';
            for (var j = 0; j < log.petugas.length; j++) {
                petugasBadges += '<span class="badge bg-light text-dark border">' + log.petugas[j] + '</span> ';
            }
            
            var fotoImages = '';
            for (var k = 0; k < log.foto.length; k++) {
                fotoImages += '<img src="' + log.foto[k] + '" class="img-preview">';
            }
            
            row.innerHTML = '<td class="ps-3"><strong>' + log.tanggal + '</strong><br><small>' + log.waktu + ' | ' + log.area + '</small></td>' +
                '<td>' + petugasBadges + '</td>' +
                '<td><small>' + log.keterangan + '</small></td>' +
                '<td>' + fotoImages + '</td>' +
                '<td class="text-center"><button class="btn btn-sm btn-outline-danger" onclick="deleteData(' + log.id + ')"><i class="bi bi-trash"></i></button></td>';
            tbody.appendChild(row);
        }
    });
}

function deleteData(id) {
    if (confirm("Hapus logbook ini?")) {
        supabaseClient.from('logbook_daily').delete().eq('id', id).then(function(response) {
            if (response.error) {
                alert("Error: " + response.error.message);
            } else {
                loadData();
            }
        });
    }
}

function fetchForPrint() {
    var from = document.getElementById('filterFrom').value;
    var to = document.getElementById('filterTo').value;
    if(!from || !to) {
        alert("Pilih rentang tanggal!");
        return;
    }

    supabaseClient.from('logbook_daily').select('*').gte('tanggal', from).lte('tanggal', to).order('tanggal', { ascending: true }).then(function(response) {
        if(response.error) {
            alert("Error: " + response.error.message);
            return;
        }
        
        if(response.data.length === 0) {
            alert("Data tidak ditemukan.");
            return;
        }

        var rows = '';
        for (var i = 0; i < response.data.length; i++) {
            var l = response.data[i];
            var fotoHtml = '';
            for (var j = 0; j < l.foto.length; j++) {
                fotoHtml += '<img src="' + l.foto[j] + '" width="60">';
            }
            rows += '<tr><td>' + (i+1) + '</td><td>' + l.tanggal + ' ' + l.waktu + '</td><td>' + l.area + '</td><td>' + l.petugas.join(', ') + '</td><td>' + l.keterangan + '</td><td>' + fotoHtml + '</td></tr>';
        }

        document.getElementById('printArea').innerHTML = '<div style="text-align:center"><h3>REKAPITULASI DAILY LOGBOOK</h3><p>Periode: ' + from + ' s/d ' + to + '</p></div><table border="1" style="width:100%; border-collapse: collapse; font-size: 12px"><thead><tr bgcolor="#eee"><th>No</th><th>Waktu</th><th>Area</th><th>Petugas</th><th>Keterangan</th><th>Foto</th></tr></thead><tbody>' + rows + '</tbody></table>';
        setTimeout(() => window.print(), 100);
    });
}


// Fungsi untuk set active menu
function setActiveMenu(element) {
    // Remove active class from all menu items
    document.querySelectorAll('#sidebar ul li a').forEach(link => {
        link.classList.remove('active');
    });
    // Add active class to clicked item
    element.classList.add('active');
}

// Expose logout function locally if not already available from logic.js
if (typeof window.logout === 'undefined') {
    window.logout = async function() {
        const confirmLogout = confirm('Apakah Anda yakin ingin keluar dari sistem?');
        if (!confirmLogout) return false;
        
        try {
            sessionStorage.clear();
            localStorage.clear();
            
            if (window.supabaseClient && window.supabaseClient.auth) {
                await window.supabaseClient.auth.signOut();
            }
            
            window.location.href = 'index.html';
            return true;
        } catch (error) {
            console.error('Logout error:', error);
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = 'index.html';
            return true;
        }
    };
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    
    // Ensure logout function is available
    if (typeof window.logout === 'undefined' && typeof logout !== 'undefined') {
        window.logout = logout;
    }
    
    // Wait for Supabase to load before showing home
    setTimeout(function() {
        showHome();
    }, 500);
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
